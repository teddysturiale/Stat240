---
title: "Section 4: Introduction to ggplot2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

## Palmer penguins data

The Palmer penguin data records several physical measurements of three penguin species from Palmer Station, Antarctica.  Use the code below to load in a tidy version of this data, from bwu62.  The .csv file must be in your `data` folder.

```{r}
## This assumes that:
### STAT240/data/ contains the data file
### STAT240/lecture/sect04-ggplot/ is your working directory.
### If this gives you "Error: could not find file ... in working directory ...", go to Session > Set Working Directory > To Source File Location, and try again.
### If that doesn't work, then you downloaded one or both files to the wrong place, or they have the wrong name - make sure they don't have a " (1)" or "-1" at the end of their names, which can happen when you download multiple times.

penguins <- read_csv("../../data/penguins.csv")
view(penguins)
```

Now explore the data.

```{r}
glimpse(penguins)
```


## Grammar of graphics

```{r}
# Basic empty canvas
ggplot()

# We defined the mapping - where is the plot?
ggplot(data = penguins,
       mapping = aes(x = body_mass_g, y = flipper_length_mm))
```

To actually build the plot, we need to specify a geom and add it to the plot.

```{r}
ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point()

ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_smooth()

ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) + 
  geom_point() + 
  geom_smooth()
```


### Customization

We can customize several aspects of our plot.

```{r}
ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point(size = 5, color = "red")

ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point(shape = 15, alpha = 0.5) +
  geom_line() +
  geom_smooth(method = "lm")
```


The gray ribbon represents a confidence interval, and can be omitted.  We can also use different methods to obtain a line.

```{r}
ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point() +
  geom_smooth(se = FALSE)

ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point() +
  geom_smooth(se = TRUE,level = .999, method = "lm")
```


## 1-variable plots

Histograms, density plots, and box plots are useful for visualizing a single variable.

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram()

# Can customize the look
ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram(
    color = "steelblue4",
    fill = "skyblue1"
  )
```

We can use `binwidth, bins, center`, and `boundary` to custoimze the bins.  These two plots have the same output:

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram(
    binwidth = 5,
    boundary = 200,
    color = "steelblue4",
    fill = "skyblue1"
  )

ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram(
    binwidth = 5,
    center = 202.5,
    color = "steelblue4",
    fill = "skyblue1"
  )
```

Try to get a good balance - not too many and not too few bins!

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_histogram(
    bins = 100,
    color = "steelblue4",
    fill = "skyblue1")

ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_histogram(
    bins = 5,
    color = "steelblue4",
    fill = "skyblue1")
```


Density plots are a "smooth" version of a histogram.

```{r}
ggplot(penguins, aes(flipper_length_mm)) +
  geom_density(
    color = "goldenrod3",
    fill = "gold",
    size = 1
  )

# Overlaying both plots
ggplot(penguins, aes(flipper_length_mm)) +
  geom_histogram(
    aes(y = after_stat(density)), # This line shrinks the histogram's height to be on the same scale as geom_density
    color = "steelblue4",
    fill = "skyblue1"
  ) +
  geom_density(
    color = "goldenrod3",
    fill = "gold",
    alpha = 0.3, # Transparency... the density plot is "on top"
    size = 2
  )
```

Boxplots visualize the quartiles of our data.

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_boxplot(fill = "skyblue")
```


Let's re-create the one-variable plots, but color by species.

```{r}
ggplot(penguins, aes(x = flipper_length_mm, color = species)) +
  geom_histogram()

ggplot(penguins, aes(x= flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3)

ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_boxplot(fill = "skyblue", alpha = 0.5)
```


### Bar graphs

Bar graphs depict a single categorical variable, like `species`.  `geom_bar()` counts the number of instances in a dataset.

```{r}
ggplot(penguins, aes(x = species)) +
  geom_bar()
```

With `geom_col()`, you specify the heights of the bars yourself.  It is more flexible than `geom_bar()` but more work to use.

Let's make a summarized version of the data with the counts and average flipper length of each species.

```{r}
# We'll cover this code next week!
penguin_summary <- penguins %>%
  group_by(species) %>%
  summarize(n_penguins = n(),
            mean_length = mean(flipper_length_mm))

penguin_summary
```

```{r}
# This code recreates the geom_bar graph
ggplot(penguin_summary, aes(x = species, y = n_penguins)) +
  geom_col()

# But we can make other plots as well
ggplot(penguin_summary, aes(x = species, mean_length)) +
  geom_col()
```

We can add fill as a constant or variable aesthetic.

```{r}
ggplot(penguins, aes(x = species)) +
  geom_bar(fill = "lightblue", col = "black")

ggplot(penguins, aes(x = species, fill = sex)) +
  geom_bar()

#position = "dodge" places bars next to each other as opposed to stacked
ggplot(penguins, aes(x = species, fill = sex)) +
  geom_bar(position = "dodge")
```


Create a bar-plot showing the count of each penguin species by island.  Decide how you want to assign the aesthetics to our two variables of interest.

```{r}
ggplot(penguins, aes(species, fill = island)) +
  geom_bar(position = "dodge")
```


## Variable aesthetics

Let's look at a scatterplot of bill depth vs flipper length.

```{r}
ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm)) +
  geom_point() +
  geom_smooth(method = "lm", se = T)
```

What if we want to color the points by species?

```{r}
ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm,
                     col = species)) +
  geom_point() +
  geom_smooth(method = "lm", se = F)
```

What if we want the points to be colored, but keep only a single smooth line?  We have to specify the color mapping within `geom_point()` rather than the original `ggplot()`.  This is called a *local* aesthetic.

```{r}
ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm)) +
  geom_point(aes(col = species)) +
  geom_smooth(method = "lm", se = F)
```

What's wrong with the following plots?  How can we fix them?

```{r}
# Read and interpret the error messages from these two plots
ggplot(penguins, aes(bill_depth_mm, flipper_length_mm)) +
  geom_point(aes(color = species))

ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm)) +
  geom_point(aes(color = species))
```

```{r}
# Why are these points not huge? Why is there a legend for "size"?
ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm, color = species)) +
  geom_point(size = 2, aes(color = species)) +
  geom_smooth(method = "lm")
#The size specification was pout inside the aesthetic mapping, while it should have been outside of the aesthetic mapping.

# This just produces a gridded canvas with no points. Why?
ggplot(penguins, aes(x = bill_depth_mm, y = flipper_length_mm,
                    color = species)) +
  geom_point()
#There was no plus sign after the ggplot line of code
```


### Line plots

Line plots are useful when our data is organized chronologically.  Let's work with a dataset showing U.S. college enrollment data by sex.

```{r}
# Another way to read data: from the internet
enrollment <- read_csv("https://bwu62.github.io/stat240-revamp/data/enrollment.csv")

glimpse(enrollment)
```

Here's the data as a scatterplot.

```{r}
ggplot(enrollment, aes(x = year, y = enrolled_millions,
                       color = sex)) +
  geom_point()
```

It makes sense to connect consecutive points with lines.

```{r}
ggplot(enrollment, aes(x = year, y = enrolled_millions,
                       color = sex, linetype = sex)) +
  geom_line()
```

This is different from a smooth line - there's no smoothing going on here!

Consider the following plot.  What happens when `color` is changed to be a local aesthetic within `geom_point()`?

```{r}
ggplot(enrollment, aes(x = year, y = enrolled_millions,
                       color = sex)) +
  geom_line() +
  geom_point()
```


## More customization

There are countless options for customization in ggplot2.  There is tons of information here - I encourage you to use this section as a reference that you can return to as needed.

### Line and text annotations

There are special geometric objects for annotating plots.

```{r}
mean_length <- mean(penguins$flipper_length_mm)

ggplot(penguins, aes(flipper_length_mm)) +
  geom_density(
    color = "goldenrod3",
    fill = "gold",
    size = 2
  ) +
  geom_vline(xintercept = mean_length,
             size = 2) 

ggplot(penguins, aes(flipper_length_mm)) +
  geom_density(
    color = "goldenrod3",
    fill = "gold",
    size = 2
  ) +
  geom_vline(xintercept = mean_length,
             size = 1.5) +
  geom_text(aes(x = 215, y = 0.03,
                label = "Mean Flipper Length"),
                stat = "unique")


ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3) +
  geom_vline(data = penguin_summary,
             aes(xintercept = mean_length, col = species))
```

### Axis labels

We should also add plot titles and improved axis labels for clarity.  This is essential for any plot that appears in a report and is meant to communicate information to a larger group.  

```{r}
ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  labs(
    title = "Density of Penguin Flipper Lengths",
    subtitle = "Vertical lines indicate average length",
    caption = "STAT 240",
    
    x = "Flipper Length (mm)",
    y = "Density",
    fill = "Species",
    col = "Species"
  ) +
  geom_density(alpha = 0.3) +
  geom_vline(data = penguin_summary,
             aes(xintercept = mean_length, col = species))
```

Scales allow us more fine-grained control over how aesthetics are displayed.  For example, we might want to customize the spacing of the x or y axes.

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram(
    binwidth = 5,
    boundary = 70,
    color = "steelblue4",
    fill = "skyblue1"
  )

ggplot(penguins, aes(x = flipper_length_mm)) + 
  geom_histogram(
    binwidth = 5,
    boundary = 70,
    color = "steelblue4",
    fill = "skyblue1"
  ) +
  # Custom x axis
  scale_x_continuous(breaks = seq(170, 240, by = 10))
```

```{r}
ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_boxplot()

# Add some extra spacing to the y-axis in the boxplot
ggplot(penguins, aes(x = flipper_length_mm)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(-1, 1))
```

This also works with discrete scales.

```{r}
ggplot(penguins, aes(x = species, fill = sex)) +
  geom_bar(position = "dodge")

scientific_names <- c("Pygoscelis adeliae", "Pygoscelis antarcticus",
                      "Pygoscelis papua")

ggplot(penguins, aes(x = species, fill = sex)) +
  geom_bar(position = "dodge") +
  scale_x_discrete(label = scientific_names)
```

### Colors

We can also use custom color schemes for the `color` and `fill` aesthetics (also can be continuous or discrete). The default color scheme can be difficult to distinguish for certain types of color blindness.

```{r}
ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3)
```

We can use viridis palettes for either the fill or the color aesthetic.

```{r}
ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3) +
  scale_fill_viridis_d()

ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3) +
  scale_fill_viridis_d(option = "inferno")
```

We can also make our own custom color scheme.

```{r}
ggplot(penguins, aes(x = flipper_length_mm, fill = species)) +
  geom_density(alpha = 0.3) +
  scale_fill_manual(
    values = c("Adelie" = "dodgerblue",
               "Chinstrap" = "peachpuff",
               "Gentoo" = "mediumorchid")
    )
```

Here's an example of a continuous color scheme.

```{r}
ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm,
                     color = flipper_length_mm)) +
  geom_point() +
  scale_color_viridis_c(option = "cividis")


ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm,
                     color = flipper_length_mm)) +
  geom_point() +
  scale_color_gradient(low = "tomato", high = "dodgerblue")
```


## Re-create a plot

Let's try recreating the ESPN plot of football teams.  

Set your y aesthetic to `reorder(team, points)` to re-order the team bars based on the number of points.

```{r}
team <- c("Wolves", "Aston Villa", "Liverpool",
           "Tottenham", "Man City")
ESPN <- tibble(team,
       points = c(2.0, 2.0, 2.2, 2.4, 2.5))

ESPN

ggplot(ESPN, aes(x= points, y= reorder(team, points), fill = team)) +
  geom_col() +
  labs(totle = "Premieer League Points Per Game MW 16-20")
```


## Other topics

### Faceting

Sometimes, it is easier to view variables as separate graphs rather than as aesthetics.  `facet_wrap()` separates the plot into separate graphs for each level of a categorical variable.

```{r}
ggplot(penguins, aes(x = body_mass_g, fill = species)) +
  geom_density(alpha = 0.3)

ggplot(penguins, aes(x = body_mass_g)) +
  geom_density() +
  facet_wrap(facets = vars(species))
```

`facet_grid()` lets us facet based on two variables.

```{r}
ggplot(penguins, aes(x = body_mass_g)) +
  geom_density() +
  facet_grid(rows = vars(species), cols = vars(sex))

# This plot is much harder to read:
ggplot(penguins, aes(x = body_mass_g,fill = species,
                     linetype = sex)) +
  geom_density(alpha = 0.5, size = 1)
```


### Mathematical functions

`geom_function()` can be used to plot y = f(x) for any pre-defined R function or for your own mathematical function.  It creates a smooth line plot.

For this type of plot, we don't provide data, but provide all of the necessary information within `geom_function()`.

```{r}
ggplot() + geom_function(
  fun = \(x) x^2 + 1,      # define xÂ²+1
  xlim = c(-2, 2),         
  n = 1001                 # increase number of points used in drawing
)
```

Here's an example using a pre-defined function, `dnorm()`, which creates a normal bell-curve.

```{r}
# plot the normal distribution with mean 10 and sd 2
ggplot() + geom_function(
  fun = dnorm,
  args = list(mean = 10, sd = 2),  # set mean and sd arguments inside dnorm()
  xlim = c(4, 16),
  n = 1001
)
```

Example: How well do the male Adelie penguin body masses match a theoretical normal distribution?

```{r}
penguins_small <- penguins %>%
  filter(species == "Adelie", sex == "male")

# Get mean and sd to draw normal curve
obs_mean <- mean(penguins_small$body_mass_g)
obs_sd <- sd(penguins_small$body_mass_g)


ggplot(penguins_small, aes(body_mass_g)) +
  geom_density(color = "goldenrod3", lwd = 1.5) +
  
  geom_function(
  fun = dnorm,
  args = list(mean = obs_mean, sd = obs_sd),
  n = 1001
)
```

